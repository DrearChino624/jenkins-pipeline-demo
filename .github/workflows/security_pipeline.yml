name: Security Pipeline Demo
# Este archivo define la versión CI/CD del pipeline "security_pipeline.py"
# Se ejecutará automáticamente en cada push a la rama principal.

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Permite ejecución manual desde la interfaz de GitHub

jobs:
  security-pipeline:
    name: SAST + DAST Security Pipeline
    runs-on: ubuntu-latest
    
    steps:
      # ------------------------------------------------------------------
      # FASE DE PREPARACIÓN
      # ------------------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install bandit

      - name: Create Reports Directory
        run: mkdir -p reports

      # ------------------------------------------------------------------
      # FASE 1: SAST (Static Analysis with Bandit)
      # ------------------------------------------------------------------
      - name: Run SAST Scan (Bandit)
        # Ejecuta Bandit y guarda resultados en JSON y HTML
        # '|| true' asegura que el pipeline no se detenga si encuentra vulnerabilidades
        run: |
          echo "Runing SAST detection..."
          python -m bandit -r app.py -f json -o reports/bandit_report.json || true
          python -m bandit -r app.py -f html -o reports/bandit_report.html || true
          python -m bandit -r app.py -f txt || true

      # ------------------------------------------------------------------
      # FASE 2: INICIAR APLICACIÓN
      # ------------------------------------------------------------------
      - name: Start Target Application
        # Iniciamos la app Flask en segundo plano (&)
        run: |
          nohup python app.py > flask.log 2>&1 &
          echo "Waiting for application to start..."
          sleep 5
          cat flask.log

      # ------------------------------------------------------------------
      # FASE 3: DAST (Dynamic Analysis with OWASP ZAP)
      # ------------------------------------------------------------------
      - name: Run DAST Scan (OWASP ZAP) via Docker
        run: |
          echo "Running OWASP ZAP baseline via Docker..."
          mkdir -p "$GITHUB_WORKSPACE/reports"
          docker --version || true
          docker run --rm \
            -v "$GITHUB_WORKSPACE/reports:/zap/wrk:rw" \
            --add-host=host.docker.internal:host-gateway \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://host.docker.internal:5000 \
            -r zap_report.html \
            -J zap_report.json \
            -I
        continue-on-error: true

      # ------------------------------------------------------------------
      # FASE 4: GUARDAR REPORTES (ARTIFACTS)
      # ------------------------------------------------------------------
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always() # Ejecutar siempre, incluso si fallan los pasos anteriores
        with:
          name: security-scan-reports
          path: |
            reports/
            zap-execution-report.html
